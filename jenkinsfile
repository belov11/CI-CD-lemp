pipeline {
  agent any

  stages {
    stage('Clone GitHub repo') {
      steps {
        git branch: 'main', 
            credentialsId: 'github-ssh-key', 
            url: 'git@github.com:belov11/CI-CD-lemp.git'
      }
    }

    stage('Transfer to web-server') {
      steps {
        script {
          // Установка параметров соединения для SSH
          withCredentials([sshUserPrivateKey(credentialsId: 'web-server-private-key', keyFileVariable: 'SSH_KEY')]) {
            def remoteHost = '192.168.56.22'
            def remoteUser = 'vagrant'
            def remoteDir = '/home/vagrant/web-sever'

            // Создание SSH-клиента
            def sshClient = new SSHClient()
            sshClient.loadKnownHosts()
            sshClient.connect(remoteHost)
            sshClient.authPublickey(remoteUser, new File(SSH_KEY))

            try {
              // Копирование репозитория с помощью scp
              sshClient.withSessions { session ->
                def scpClient = session.createSCPClient()
                scpClient.putRecursive('repository', remoteDir, '0700')
              }
            } finally {
              sshClient.disconnect()
            }
          }
        }
      }
    }
  }
}
