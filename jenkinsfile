pipeline {
  agent any

  stages {
    stage('Clone GitHub repo') {
      steps {
        git 'https://github.com/belov11/CI-CD-lemp.git'
      }
    }

    stage('Transfer to Server') {
      steps {
        script {
          // Установка параметров соединения для SSH
          def remoteHost = '192.168.56.22'
          def remoteUser = 'vagrant'
          def remoteDir = '/home/vagrant/web-ser/'
          def gitRepoUrl = 'https://github.com/belov11/CI-CD-lemp'
          def gitBranch = 'main'
          def gitAPI = "<${gitRepoUrl}/archive/refs/heads/${gitBranch}.tar.gz>"
          sh "curl -Lso web-app.tar.gz ${gitAPI}"

          // https://github.com/belov11/CI-CD-lemp/archive/refs/heads/main.tar.gz

          // Создание SSH-клиента
          sshagent(['web-server-private-key']) {
            //sh "git clone https://github.com/belov11/CI-CD-lemp.git
            sh "ssh ${remoteUser}@${remoteHost} mkdir -p ${remoteDir}"
            sh "scp -r /home/vagrant/web-app.tar.gz ${remoteUser}@${remoteHost}:${remoteDir}"
          }
        }
      }
    }
  }
}
